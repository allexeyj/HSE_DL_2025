# üìù HSE DL 2025: Stage 2 - Text-to-3D Alignment

**–í–µ—Ç–∫–∞:** `project_training_stage_2`

–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ —Ä–µ—à–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ Text-to-3D Retrieval. –ú—ã –±–µ—Ä–µ–º –æ–±—É—á–µ–Ω–Ω—ã–π –Ω–∞ Stage 1 3D Encoder (ReConV2), –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º –µ–≥–æ, –∏ –æ–±—É—á–∞–µ–º Text Encoder (EVA-02 + Projection) –ø—Ä–æ–µ—Ü–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤ —Ç–æ –∂–µ —Å–∞–º–æ–µ –º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

*   **3D Encoder:** ReConV2 (–≤–µ—Å–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Stage 1). **–ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–æ—Ä–æ–∂–µ–Ω**
*   **Text Encoder:** OpenCLIP (EVA02-L-14-336).
    *   –ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —Å–ª–æ–µ–≤ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞.
    *   –†–∞–∑–º–æ—Ä–æ–∂–µ–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ `N` —Å–ª–æ–µ–≤ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ, default=4).
*   **Text Projection:** –ü–æ–ª–Ω–æ—Å–≤—è–∑–Ω–∞—è —Å–µ—Ç—å (MLP) –¥–ª—è –ø—Ä–æ–µ–∫—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞.
*   **Loss:** `ContrastiveLoss` (Symmetric InfoNCE) –º–µ–∂–¥—É –ø–∞—Ä–∞–º–∏ (–¢–µ–∫—Å—Ç, 3D Mesh).

## üöÄ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –ó–∞–ø—É—Å–∫

### 1. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–º–µ—Ç—å —Ñ–∞–π–ª –≤–µ—Å–æ–≤ 3D —ç–Ω–∫–æ–¥–µ—Ä–∞ (`pc_encoder_*.pth`), –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –Ω–∞ Stage 1.

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–ª–∏—Ç–æ–≤
–î–ª—è –æ–±—É—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–π–ª —Å–ø–ª–∏—Ç–∞ (train/val). –ú–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å K-Fold —Ä–∞–∑–±–∏–µ–Ω–∏–µ:

```bash
python -m cad_retrieval_utils.generate_k_folds --n_folds 5
```
–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ–π split:
```bash
python cad_retrieval_utils/generate_split.py
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞
–§–∞–π–ª: `cad_retrieval_utils/configs/config.py`.

### 4. –û–±—É—á–µ–Ω–∏–µ
```bash
python -m cad_retrieval_utils.train --config cad_retrieval_utils/configs/config.py
```

–°–∫—Ä–∏–ø—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç:
1.  `text_proj_*.pth` ‚Äî –≤–µ—Å–∞ –ø—Ä–æ–µ–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–ª–æ—è.
2.  `text_encoder_*.pth` ‚Äî –≤–µ—Å–∞ —Ä–∞–∑–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö —Å–ª–æ–µ–≤ —ç–Ω–∫–æ–¥–µ—Ä–∞.

### 5. –ò–Ω—Ñ–µ—Ä–µ–Ω—Å (–°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–±–º–∏—Ç–∞)
–†–µ—à–∞–µ—Ç –∑–∞–¥–∞—á–∏ `Text -> Mesh` –∏ `Mesh -> Text`.
–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç Stage 1, –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç–∏ –∫ —Ç—Ä–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º –≤–µ—Å–æ–≤:

```bash
python -m cad_retrieval_utils.inference_runner \
    --config cad_retrieval_utils/configs/config.py \
    --pc_encoder path/to/stage1_pc_encoder.pth \
    --text_proj path/to/stage2_text_proj.pth \
    --text_encoder path/to/stage2_text_encoder.pth \
    --output submission_stage2.csv
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ–¥–µ—Ç—Å—è –≤ Weights & Biases.
*   Recall@K (1, 3, 5, 10) –¥–ª—è Text-to-Mesh.
*   Recall@K –¥–ª—è Mesh-to-Text.
*   –°—Ä–µ–¥–Ω–∏–π Recall@5 (Avg) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª—É—á—à–∏—Ö —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤.
